<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.84.3" /><META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href="/favicon.png" >
<link rel="apple-touch-icon" href="/favicon.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicon.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicon.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicon.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicon.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicon.png" sizes="192x192">

<title>Automate image updates to Git | 道场</title>
<meta name="description" content="Open and extensible continuous delivery solution for Kubernetes."><meta property="og:title" content="Automate image updates to Git" />
<meta property="og:description" content="Automate container image updates to Git with Flux." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/iac/image-update/" /><meta property="og:image" content="/img/flux-social.png"/><meta property="article:section" content="docs" />



<meta itemprop="name" content="Automate image updates to Git">
<meta itemprop="description" content="Automate container image updates to Git with Flux.">

<meta itemprop="wordCount" content="2916"><meta itemprop="image" content="/img/flux-social.png"/>
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/img/flux-social.png"/>

<meta name="twitter:title" content="Automate image updates to Git"/>
<meta name="twitter:description" content="Automate container image updates to Git with Flux."/>




<link rel="preload" href="/scss/main.min.4a9db146ac33069ee85be0885ccf5f1ce3a4387f774ad3c60af13d7316e8cedc.css" as="style">
<link href="/scss/main.min.4a9db146ac33069ee85be0885ccf5f1ce3a4387f774ad3c60af13d7316e8cedc.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />





  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>flux-icon</title><desc>Created with Sketch.</desc><g id="flux-icon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Group" transform="translate(11.000000, 2.000000)"><path d="M.803134615 15.7791346c-1.049423077-.682500000000001-1.049423077-2.2188461.0-2.9007692L20.1819808.279519231c.573461499999997-.3726923079 1.3125-.3726923079 1.8859615.0L41.4473654 12.8783654c1.0494231.681923100000001 1.0494231 2.2182692.0 2.9007692L22.0679423 28.3779808C21.4944808 28.7506731 20.7554423 28.7506731 20.1819808 28.3779808L.803134615 15.7791346z" id="Fill-1" fill="#326ce5"/><path d="M24.1851346 18.0023077h1.3442308C26.3145577 18.0023077 26.8055192 17.1525 26.4126346 16.4728846L22.0084038 8.84423077C21.6160962 8.16461538 20.63475 8.16461538 20.2418654 8.84423077L15.8376346 16.4728846C15.4453269 17.1525 15.9357115 18.0023077 16.7209038 18.0023077h1.3448077c.563077.0 1.0194231.456923100000001 1.0194231 1.02v8.7075L19.9874423 28.3165385C20.6791731 28.7665385 21.5710962 28.7665385 22.2628269 28.3165385L23.1651346 27.7298077v-8.7075c0-.563076899999999.456346200000002-1.02 1.02-1.02" id="Fill-3" fill="#c1d2f7"/><path d="M27.8390769 34.8375577l-4.6742307-3.0386539v1.44C24.6902308 33.8919808 26.2588846 34.4008269 27.8390769 34.8375577" id="Fill-5" fill="#326ce5"/><path d="M23.1650769 35.8280192v2.0215385C24.7095 38.3209038 26.2723846 38.7080192 27.8191154 39.0893654c5.0515384 1.2455769 9.8226923 2.4213461 13.6592308 6.2584615C41.6733462 45.54225 41.8562308 45.7407115 42.0373846 45.93975 42.4308462 45.1880192 42.2335385 44.1957115 41.4466154 43.6845577l-7.5905769-4.9355769c-1.8426923-.608077000000002-3.72-1.073077-5.5753847-1.53C26.5308462 36.7874423 24.8196923 36.3570577 23.1650769 35.8280192" id="Fill-7" fill="#326ce5"/><path d="M19.08525 34.1699423C18.4304423 33.8318654 17.7854423 33.4689808 17.1629423 33.0489808l-1.7359615 1.1284615c1.1705769.8607692 2.3965384 1.5588462 3.6582692 2.1438462V34.1699423z" id="Fill-9" fill="#326ce5"/><path d="M24.8941731 40.6051154C24.3137885 40.4620385 23.7374423 40.3195385 23.1651346 40.1735769V42.1605C23.5885962 42.2666538 24.0114808 42.3722308 24.4326346 42.4760769c5.0515385 1.245 9.8226923 2.4207693 13.6598077 6.2578846C38.0987885 48.7408846 38.1045577 48.7472308 38.1114808 48.7541538L39.75225 47.6868462C39.6524423 47.5824231 39.5584038 47.4751154 39.4545577 47.3718462c-4.2161539-4.2167308-9.4753846-5.513077-14.5603846-6.7667308" id="Fill-11" fill="#326ce5"/><path d="M19.08525 38.9907115C16.8900577 38.2389808 14.8096731 37.2714808 12.9115962 35.8124423l-1.6996154 1.1053846c2.4167307 1.9932693 5.1075 3.2025 7.8732692 4.0990385V38.9907115z" id="Fill-13" fill="#326ce5"/><path d="M19.08525 43.3809808C15.3069808 42.3909808 11.7537115 41.18175 8.71794231 38.5388654L7.04717308 39.6252115c3.56538462 3.285 7.80692312 4.658077 12.03807692 5.745577V43.3809808z" id="Fill-15" fill="#326ce5"/><path d="M23.1650769 46.3935c3.9525 1.02057689999999 7.6690385 2.2407692 10.8173077 5.0446154l1.6615385-1.08c-3.6784616-3.4580769-8.0925-4.8386539-12.4788462-5.9532692V46.3935z" id="Fill-17" fill="#326ce5"/><path d="M4.57875 41.2299231 2.92990385 42.3018462C2.98759615 42.3612692 3.04009615 42.423 3.09951923 42.4818462 7.31625 46.6985769 12.5743269 47.9949231 17.6599038 49.2485769c4.4042308 1.0851923 8.5944231 2.1201923 12.1390385 4.9096154L31.4893269 53.0591538C27.4958654 49.6968462 22.7385577 48.5158846 18.1214423 47.3781923 13.1206731 46.1453077 8.39567308 44.9758846 4.57875 41.2299231" id="Fill-19" fill="#326ce5"/><path d="M1.07555769 44.5060962C.883442308 44.3139808.702865385 44.1184038.524019231 43.9216731-.227711538 44.6745577-.139442308 45.9726346.80325 46.5853269l5.70634615 3.7101923c2.52576923 1.0453846 5.16692305 1.6990385 7.76423075 2.3394231 4.0546154.999230799999999 7.9280769 1.9575 11.2840385 4.2807692l1.7255769-1.1226923C23.4676731 52.9245577 19.0403654 51.8255192 14.7347885 50.7639808c-5.05096158-1.245-9.82211542-2.4207693-13.65923081-6.2578846" id="Fill-21" fill="#326ce5"/><path d="M19.6441154 58.8342692C20.0243077 59.0188846 20.3998846 59.2133077 20.7691154 59.4221538 21.2093077 59.5150385 21.6771923 59.4383077 22.0683462 59.1838846L23.0260385 58.5613846C19.9493077 56.5035 16.5287308 55.461 13.1196923 54.5927308l6.5244231 4.2415384z" id="Fill-23" fill="#326ce5"/></g></g></svg></span><span class="text-uppercase font-weight-bold">道场</span>
	</a>
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs" ><span>修习</span></a>
				
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>动态</span></a>
				
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/devopschina/sig/" target="_blank" ><i class='fab fa-github'></i> <span>Github</span></a>
				
			</li>
			
			
			
			<li class="nav-item nav-search-item">
<input type="search" class="form-control td-search-input" placeholder="&#xf002; " aria-label="" autocomplete="off">

</li>
		</ul>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            




  


<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  
  <nav class="collapse td-sidebar-nav foldable-nav" id="td-section-nav">
    
    
    
    
    
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
    
      <a href="/docs/" title="入门指南" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">道场</span></a>
    
    
      
      <ul class="ul-1">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconcepts-li">
    
      <input type="checkbox" id="m-docsconcepts-check"/>
      <label for="m-docsconcepts-check"><a href="/docs/concepts/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconcepts"><span class="">核心概念</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsget-started-li">
    
      <input type="checkbox" id="m-docsget-started-check"/>
      <label for="m-docsget-started-check"><a href="/docs/get-started/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsget-started"><span class="">转型方法</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docstool-chain-li">
    
      <input type="checkbox" id="m-docstool-chain-check"/>
      <label for="m-docstool-chain-check"><a href="/docs/tool-chain/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docstool-chain"><span class="">工具链</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsiac-li">
    
      <input type="checkbox" id="m-docsiac-check" checked/>
      <label for="m-docsiac-check"><a href="/docs/iac/" title="基础设施即代码" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsiac"><span class="">IaC</span></a></label>
    
    
      
      <ul class="ul-2 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacrepository-structure-li">
    
      <input type="checkbox" id="m-docsiacrepository-structure-check"/>
      <label for="m-docsiacrepository-structure-check"><a href="/docs/iac/repository-structure/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacrepository-structure"><span class="">Ways of structuring your repositories</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiachelmreleases-li">
    
      <input type="checkbox" id="m-docsiachelmreleases-check"/>
      <label for="m-docsiachelmreleases-check"><a href="/docs/iac/helmreleases/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiachelmreleases"><span class="">Manage Helm Releases</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacnotifications-li">
    
      <input type="checkbox" id="m-docsiacnotifications-check"/>
      <label for="m-docsiacnotifications-check"><a href="/docs/iac/notifications/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacnotifications"><span class="">Setup Notifications</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacwebhook-receivers-li">
    
      <input type="checkbox" id="m-docsiacwebhook-receivers-check"/>
      <label for="m-docsiacwebhook-receivers-check"><a href="/docs/iac/webhook-receivers/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacwebhook-receivers"><span class="">Setup Webhook Receivers</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacmonitoring-li">
    
      <input type="checkbox" id="m-docsiacmonitoring-check"/>
      <label for="m-docsiacmonitoring-check"><a href="/docs/iac/monitoring/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacmonitoring"><span class="">Monitoring with Prometheus</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacsealed-secrets-li">
    
      <input type="checkbox" id="m-docsiacsealed-secrets-check"/>
      <label for="m-docsiacsealed-secrets-check"><a href="/docs/iac/sealed-secrets/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacsealed-secrets"><span class="">Sealed Secrets</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacmozilla-sops-li">
    
      <input type="checkbox" id="m-docsiacmozilla-sops-check"/>
      <label for="m-docsiacmozilla-sops-check"><a href="/docs/iac/mozilla-sops/" title="Manage Kubernetes secrets with Mozilla SOPS" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacmozilla-sops"><span class="">Mozilla SOPS</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsiacimage-update-li">
    
      <input type="checkbox" id="m-docsiacimage-update-check" checked/>
      <label for="m-docsiacimage-update-check"><a href="/docs/iac/image-update/" class="align-left pl-0  active td-sidebar-link td-sidebar-link__page" id="m-docsiacimage-update"><span class="td-sidebar-nav-active-item">Automate image updates to Git</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiacsortable-image-tags-li">
    
      <input type="checkbox" id="m-docsiacsortable-image-tags-check"/>
      <label for="m-docsiacsortable-image-tags-check"><a href="/docs/iac/sortable-image-tags/" title="How to make sortable image tags to use with automation" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsiacsortable-image-tags"><span class="">Sortable image tags to use with automation</span></a></label>
    
    
  </li>

          
        
      </ul>
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsagile-li">
    
      <input type="checkbox" id="m-docsagile-check"/>
      <label for="m-docsagile-check"><a href="/docs/agile/" title="敏捷道场" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagile"><span class="">Agile</span></a></label>
    
    
      
      <ul class="ul-2 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsagilesource-li">
    
      <input type="checkbox" id="m-docsagilesource-check"/>
      <label for="m-docsagilesource-check"><a href="/docs/agile/source/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagilesource"><span class="">Source Controller</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsagilekustomize-li">
    
      <input type="checkbox" id="m-docsagilekustomize-check"/>
      <label for="m-docsagilekustomize-check"><a href="/docs/agile/kustomize/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagilekustomize"><span class="">Kustomize Controller</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsagilehelm-li">
    
      <input type="checkbox" id="m-docsagilehelm-check"/>
      <label for="m-docsagilehelm-check"><a href="/docs/agile/helm/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagilehelm"><span class="">Helm Controller</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsagilenotification-li">
    
      <input type="checkbox" id="m-docsagilenotification-check"/>
      <label for="m-docsagilenotification-check"><a href="/docs/agile/notification/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagilenotification"><span class="">Notification Controller</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsagileimage-li">
    
      <input type="checkbox" id="m-docsagileimage-check"/>
      <label for="m-docsagileimage-check"><a href="/docs/agile/image/" title="Image reflector and automation controllers" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsagileimage"><span class="">Image Automation Controllers</span></a></label>
    
    
  </li>

          
        
      </ul>
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsgitops-toolkit-li">
    
      <input type="checkbox" id="m-docsgitops-toolkit-check"/>
      <label for="m-docsgitops-toolkit-check"><a href="/docs/gitops-toolkit/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsgitops-toolkit"><span class="">Toolkit Dev Guides</span></a></label>
    
    
      
      <ul class="ul-2 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitops-toolkitpackages-li">
    
      <input type="checkbox" id="m-docsgitops-toolkitpackages-check"/>
      <label for="m-docsgitops-toolkitpackages-check"><a href="/docs/gitops-toolkit/packages/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitops-toolkitpackages"><span class="">Using the GitOps Toolkit APIs with Go</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitops-toolkitsource-watcher-li">
    
      <input type="checkbox" id="m-docsgitops-toolkitsource-watcher-check"/>
      <label for="m-docsgitops-toolkitsource-watcher-check"><a href="/docs/gitops-toolkit/source-watcher/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitops-toolkitsource-watcher"><span class="">Watching for source changes</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitops-toolkitdebugging-li">
    
      <input type="checkbox" id="m-docsgitops-toolkitdebugging-check"/>
      <label for="m-docsgitops-toolkitdebugging-check"><a href="/docs/gitops-toolkit/debugging/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitops-toolkitdebugging"><span class="">Advanced debugging</span></a></label>
    
    
  </li>

          
        
      </ul>
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsgitops-li">
    
      <input type="checkbox" id="m-docsgitops-check"/>
      <label for="m-docsgitops-check"><a href="/docs/gitops/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsgitops"><span class="">GitOps</span></a></label>
    
    
      
      <ul class="ul-2 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitopspackages-li">
    
      <input type="checkbox" id="m-docsgitopspackages-check"/>
      <label for="m-docsgitopspackages-check"><a href="/docs/gitops/packages/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitopspackages"><span class="">Using the GitOps Toolkit APIs with Go</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitopssource-watcher-li">
    
      <input type="checkbox" id="m-docsgitopssource-watcher-check"/>
      <label for="m-docsgitopssource-watcher-check"><a href="/docs/gitops/source-watcher/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitopssource-watcher"><span class="">Watching for source changes</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgitopsdebugging-li">
    
      <input type="checkbox" id="m-docsgitopsdebugging-check"/>
      <label for="m-docsgitopsdebugging-check"><a href="/docs/gitops/debugging/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgitopsdebugging"><span class="">Advanced debugging</span></a></label>
    
    
  </li>

          
        
      </ul>
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsroadmap-li">
    
      <input type="checkbox" id="m-docsroadmap-check"/>
      <label for="m-docsroadmap-check"><a href="/docs/roadmap/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsroadmap"><span class="">Roadmap</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsfaq-li">
    
      <input type="checkbox" id="m-docsfaq-check"/>
      <label for="m-docsfaq-check"><a href="/docs/faq/" title="Frequently asked questions" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsfaq"><span class="">FAQ</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docscontributing-li">
    
      <input type="checkbox" id="m-docscontributing-check"/>
      <label for="m-docscontributing-check"><a href="/docs/contributing/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docscontributing"><span class="">Contributing</span></a></label>
    
    
      
      <ul class="ul-2 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docscontributingdocs-li">
    
      <input type="checkbox" id="m-docscontributingdocs-check"/>
      <label for="m-docscontributingdocs-check"><a href="/docs/contributing/docs/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docscontributingdocs"><span class="">Documentation</span></a></label>
    
    
      
      <ul class="ul-3 foldable">
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscontributingdocssome-background-li">
    
      <input type="checkbox" id="m-docscontributingdocssome-background-check"/>
      <label for="m-docscontributingdocssome-background-check"><a href="/docs/contributing/docs/some-background/" title="Where to find the docs and how to contribute" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscontributingdocssome-background"><span class="">Some background</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscontributingdocsproposing-changes-li">
    
      <input type="checkbox" id="m-docscontributingdocsproposing-changes-check"/>
      <label for="m-docscontributingdocsproposing-changes-check"><a href="/docs/contributing/docs/proposing-changes/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscontributingdocsproposing-changes"><span class="">Proposing changes</span></a></label>
    
    
  </li>

          
        
          
            
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscontributingdocswriting-docs-li">
    
      <input type="checkbox" id="m-docscontributingdocswriting-docs-check"/>
      <label for="m-docscontributingdocswriting-docs-check"><a href="/docs/contributing/docs/writing-docs/" title="Docs from the ground up" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docscontributingdocswriting-docs"><span class="">Writing docs</span></a></label>
    
    
  </li>

          
        
      </ul>
    
  </li>

          
        
      </ul>
    
  </li>

          
        
      </ul>
    
  </li>

    </ul>
  </nav>
</div>




          </aside>
          
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
  
  
  
  
  
  
  
  <div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
  
    
    
      
    
    
    
    
    
    
    

    
    <a href="https://github.com/fluxcd/website/edit/main/content/zh-cn/docs/iac/image-update.md" target="_blank"><i class="fa fa-edit fa-fw"></i> </a>
    <a href="https://github.com/fluxcd/website/new/main/content/zh-cn/docs/iac/image-update.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" target="_blank"><i class="fa fa-edit fa-fw"></i> </a>
    
    <a href="https://github.com/fluxcd/website/issues/new?title=Automate%20image%20updates%20to%20Git" target="_blank"><i class="fab fa-github fa-fw"></i> </a>
    
      
      <a href="https://github.com/fluxcd/flux2/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> </a>
    

  
  
  </div>


            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#install-flux">Install Flux</a></li>
    <li><a href="#deploy-a-demo-app">Deploy a demo app</a></li>
    <li><a href="#configure-image-scanning">Configure image scanning</a></li>
    <li><a href="#configure-image-updates">Configure image updates</a></li>
    <li><a href="#configure-image-update-for-custom-resources">Configure image update for custom resources</a></li>
    <li><a href="#push-updates-to-a-different-branch">Push updates to a different branch</a></li>
    <li><a href="#configure-the-commit-message">Configure the commit message</a></li>
    <li><a href="#trigger-image-updates-with-webhooks">Trigger image updates with webhooks</a></li>
    <li><a href="#incident-management">Incident management</a>
      <ul>
        <li><a href="#suspend-automation">Suspend automation</a></li>
        <li><a href="#revert-image-updates">Revert image updates</a></li>
      </ul>
    </li>
    <li><a href="#imagerepository-cloud-providers-authentication">ImageRepository cloud providers authentication</a>
      <ul>
        <li><a href="#aws-elastic-container-registry">AWS Elastic Container Registry</a></li>
        <li><a href="#gcp-container-registry">GCP Container Registry</a></li>
        <li><a href="#azure-container-registry">Azure Container Registry</a></li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          
          
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
          
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="/docs/">道场</a>
</li>




<li class="breadcrumb-item" >
	<a href="/docs/iac/">IaC</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="/docs/iac/image-update/">Automate image updates to Git</a>
</li>

	</ol>
</nav	>

            
            
<div class="td-content">
	<h1>Automate image updates to Git</h1>
	<div class="lead">Automate container image updates to Git with Flux.</div>
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>    
	<p>This guide walks you through configuring container image scanning and deployment rollouts with Flux.</p>
<p>For a container image you can configure Flux to:</p>
<ul>
<li>scan the container registry and fetch the image tags</li>
<li>select the latest tag based on the defined policy (semver, calver, regex)</li>
<li>replace the tag in Kubernetes manifests (YAML format)</li>
<li>checkout a branch, commit and push the changes to the remote Git repository</li>
<li>apply the changes in-cluster and rollout the container image</li>
</ul>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Alpha version</h4>

    Note that the image update feature is currently alpha,
see the 
<a href="/docs/roadmap/">roadmap</a> for more details.

</div>

<p>For production environments, this feature allows you to automatically deploy application patches
(CVEs and bug fixes), and keep a record of all deployments in Git history.</p>
<p><strong>Production CI/CD workflow</strong></p>
<ul>
<li>DEV: push a bug fix to the app repository</li>
<li>DEV: bump the patch version and release e.g. <code>v1.0.1</code></li>
<li>CI: build and push a container image tagged as <code>registry.domain/org/app:v1.0.1</code></li>
<li>CD: pull the latest image metadata from the app registry (Flux image scanning)</li>
<li>CD: update the image tag in the app manifest to <code>v1.0.1</code> (Flux cluster to Git reconciliation)</li>
<li>CD: deploy <code>v1.0.1</code> to production clusters (Flux Git to cluster reconciliation)</li>
</ul>
<p>For staging environments, this features allow you to deploy the latest build of a branch,
without having to manually edit the app deployment manifest in Git.</p>
<p><strong>Staging CI/CD workflow</strong></p>
<ul>
<li>DEV: push code changes to the app repository <code>main</code> branch</li>
<li>CI: build and push a container image tagged as <code>${GIT_BRANCH}-${GIT_SHA:0:7}-$(date +%s)</code></li>
<li>CD: pull the latest image metadata from the app registry (Flux image scanning)</li>
<li>CD: update the image tag in the app manifest to <code>main-2d3fcbd-1611906956</code> (Flux cluster to Git reconciliation)</li>
<li>CD: deploy <code>main-2d3fcbd-1611906956</code> to staging clusters (Flux Git to cluster reconciliation)</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<p>You will need a Kubernetes cluster version 1.16 or newer and kubectl version 1.18.
For a quick local test, you can use 
<a href="https://kind.sigs.k8s.io/docs/user/quick-start/" target="_blank">Kubernetes kind</a>.
Any other Kubernetes setup will work as well.</p>
<p>In order to follow the guide you&rsquo;ll need a GitHub account and a

<a href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line" target="_blank">personal access token</a>
that can create repositories (check all permissions under <code>repo</code>).</p>
<p>Export your GitHub personal access token and username:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#007020">export</span> <span style="color:#bb60d5">GITHUB_TOKEN</span><span style="color:#666">=</span>&lt;your-token&gt;
<span style="color:#007020">export</span> <span style="color:#bb60d5">GITHUB_USER</span><span style="color:#666">=</span>&lt;your-username&gt;
</code></pre></div><h2 id="install-flux">Install Flux</h2>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Enable image automation components</h4>

    If you bootstrapped Flux before, you need to add
<code>--components-extra=image-reflector-controller,image-automation-controller</code> to your
bootstrapping routine as image automation components are not installed by default.

</div>

<p>Install Flux with the image automation components:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux bootstrap github <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --components-extra<span style="color:#666">=</span>image-reflector-controller,image-automation-controller <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --owner<span style="color:#666">=</span><span style="color:#bb60d5">$GITHUB_USER</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --repository<span style="color:#666">=</span>flux-image-updates <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --branch<span style="color:#666">=</span>main <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --path<span style="color:#666">=</span>clusters/my-cluster <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --read-write-key <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --personal
</code></pre></div><p>The bootstrap command creates a repository if one doesn&rsquo;t exist, and commits the manifests for the
Flux components to the default branch at the specified path. It then configures the target cluster to
synchronize with the specified path inside the repository.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">GitLab and other Git platforms</h4>

    You can install Flux and bootstrap repositories hosted on GitLab, BitBucket, Azure DevOps and
any other Git provider that support SSH or token-based authentication.
When using SSH, make sure the deploy key is configured with write access <code>--read-write-key</code>.
Please see the 
<a href="../installation/">installation guide</a> for more details.

</div>

<h2 id="deploy-a-demo-app">Deploy a demo app</h2>
<p>We&rsquo;ll be using a tiny webapp called 
<a href="https://github.com/stefanprodan/podinfo" target="_blank">podinfo</a> to
showcase the image update feature.</p>
<p>Clone your repository with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone https://github.com/<span style="color:#bb60d5">$GITHUB_USER</span>/flux-image-updates
<span style="color:#007020">cd</span> flux-image-updates
</code></pre></div><p>Add the podinfo Kubernetes deployment file inside <code>cluster/my-cluster</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -sL https://raw.githubusercontent.com/stefanprodan/podinfo/5.0.0/kustomize/deployment.yaml <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>&gt; ./clusters/my-cluster/podinfo-deployment.yaml
</code></pre></div><p>Commit and push changes to main branch:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git commit -m <span style="color:#4070a0">&#34;add podinfo deployment&#34;</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git push origin main
</code></pre></div><p>Tell Flux to pull and apply the changes or wait one minute for Flux to detect the changes on its own:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux reconcile kustomization flux-system --with-source
</code></pre></div><p>Print the podinfo image deployed on your cluster:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl get deployment/podinfo -oyaml | grep <span style="color:#4070a0">&#39;image:&#39;</span>
image: ghcr.io/stefanprodan/podinfo:5.0.0
</code></pre></div><h2 id="configure-image-scanning">Configure image scanning</h2>
<p>Create an <code>ImageRepository</code> to tell Flux which container registry to scan for new tags:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image repository podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--image<span style="color:#666">=</span>ghcr.io/stefanprodan/podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--interval<span style="color:#666">=</span>1m <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--export &gt; ./clusters/my-cluster/podinfo-registry.yaml
</code></pre></div><p>The above command generates the following manifest:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>image.toolkit.fluxcd.io/v1alpha2<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageRepository<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">interval</span>:<span style="color:#bbb"> </span>1m0s<span style="color:#bbb">
</span></code></pre></div><p>For private images, you can create a Kubernetes secret
in the same namespace as the <code>ImageRepository</code> with
<code>kubectl create secret docker-registry</code>. Then you can configure
Flux to use the credentials by referencing the Kubernetes secret
in the <code>ImageRepository</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageRepository<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">secretRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>regcred<span style="color:#bbb">
</span></code></pre></div>

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Storing secrets in Git</h4>

    Note that if you want to store the image pull secret in Git,  you can encrypt
the manifest with 
<a href="/docs/iac/mozilla-sops/">Mozilla SOPS</a> or 
<a href="/docs/iac/sealed-secrets/">Sealed Secrets</a>.

</div>

<p>Create an <code>ImagePolicy</code> to tell Flux which semver range to use when filtering tags:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image policy podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--image-ref<span style="color:#666">=</span>podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--select-semver<span style="color:#666">=</span>5.0.x <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--export &gt; ./clusters/my-cluster/podinfo-policy.yaml
</code></pre></div><p>The above command generates the following manifest:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>image.toolkit.fluxcd.io/v1alpha2<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImagePolicy<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">imageRepositoryRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">policy</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">semver</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">range</span>:<span style="color:#bbb"> </span><span style="color:#40a070">5.0</span>.x<span style="color:#bbb">
</span></code></pre></div>

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Semver Ranges</h4>

    A semver range that includes stable releases can be defined with
<code>1.0.x</code> (patch versions only) or <code>&gt;=1.0.0 &lt;2.0.0</code> (minor and patch versions).
If you want to include pre-release e.g. <code>1.0.0-rc.1</code>,
you can define a range like: <code>^1.x-0</code> or <code>&gt;1.0.0-rc &lt;2.0.0-rc</code>.

</div>



<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Other policy examples</h4>

    For policies that make use of CalVer, build IDs or alphabetical sorting,
have a look at 
<a href="../components/image/imagepolicies.md#examples">the examples</a>.

</div>

<p>Commit and push changes to main branch:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git commit -m <span style="color:#4070a0">&#34;add podinfo image scan&#34;</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git push origin main
</code></pre></div><p>Tell Flux to pull and apply changes:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux reconcile kustomization flux-system --with-source
</code></pre></div><p>Wait for Flux to fetch the image tag list from GitHub container registry:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ flux get image repository podinfo
NAME   	READY	MESSAGE                       	LAST SCAN
podinfo	True 	successful scan, found <span style="color:#40a070">13</span> tags	2020-12-13T17:51:48+02:00
</code></pre></div><p>Find which image tag matches the policy semver range with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ flux get image policy podinfo
NAME   	READY	MESSAGE                   
podinfo	True 	Latest image tag <span style="color:#007020;font-weight:bold">for</span> <span style="color:#4070a0">&#39;ghcr.io/stefanprodan/podinfo&#39;</span> resolved to: 5.0.3
</code></pre></div><h2 id="configure-image-updates">Configure image updates</h2>
<p>Edit the <code>podinfo-deployment.yaml</code> and add a marker to tell Flux which policy to use when updating the container image:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfod<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo:5.0.0<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo&#34;}</span><span style="color:#bbb">
</span></code></pre></div><p>Create an <code>ImageUpdateAutomation</code> to tell Flux which Git repository to write image updates to:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image update flux-system <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--git-repo-ref<span style="color:#666">=</span>flux-system <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--git-repo-path<span style="color:#666">=</span><span style="color:#4070a0">&#34;./clusters/my-cluster&#34;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--checkout-branch<span style="color:#666">=</span>main <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--push-branch<span style="color:#666">=</span>main <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--author-name<span style="color:#666">=</span>fluxcdbot <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--author-email<span style="color:#666">=</span>fluxcdbot@users.noreply.github.com <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--commit-template<span style="color:#666">=</span><span style="color:#4070a0">&#34;{{range .Updated.Images}}{{println .}}{{end}}&#34;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--export &gt; ./clusters/my-cluster/flux-system-automation.yaml
</code></pre></div><p>The above command generates the following manifest:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>image.toolkit.fluxcd.io/v1alpha2<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageUpdateAutomation<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">interval</span>:<span style="color:#bbb"> </span>1m0s<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">sourceRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>GitRepository<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">git</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">checkout</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">ref</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">branch</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">commit</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">author</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">email</span>:<span style="color:#bbb"> </span>fluxcdbot@users.noreply.github.com<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>fluxcdbot<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">messageTemplate</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#39;{{range .Updated.Images}}{{println .}}{{end}}&#39;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">push</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">branch</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">update</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">path</span>:<span style="color:#bbb"> </span>./clusters/my-cluster<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">strategy</span>:<span style="color:#bbb"> </span>Setters<span style="color:#bbb">
</span></code></pre></div><p>Commit and push changes to main branch:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git add -A <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git commit -m <span style="color:#4070a0">&#34;add image updates automation&#34;</span> <span style="color:#666">&amp;&amp;</span> <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>git push origin main
</code></pre></div><p>Note that the <code>ImageUpdateAutomation</code> runs all the policies found in its namespace at the specified interval.</p>
<p>Tell Flux to pull and apply changes:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux reconcile kustomization flux-system --with-source
</code></pre></div><p>In a couple of seconds, Flux will push a commit to your repository with
the latest image tag that matches the podinfo policy:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ git pull <span style="color:#666">&amp;&amp;</span> cat clusters/my-cluster/podinfo-deployment.yaml | grep <span style="color:#4070a0">&#34;image:&#34;</span>
image: ghcr.io/stefanprodan/podinfo:5.0.3 <span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo&#34;}</span>
</code></pre></div><p>Wait for Flux to apply the latest commit on the cluster and verify that podinfo was updated to <code>5.0.3</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ watch <span style="color:#4070a0">&#34;kubectl get deployment/podinfo -oyaml | grep &#39;image:&#39;&#34;</span>
image: ghcr.io/stefanprodan/podinfo:5.0.3
</code></pre></div><p>You can check the status of the image automation objects with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux get images all --all-namespaces
</code></pre></div><h2 id="configure-image-update-for-custom-resources">Configure image update for custom resources</h2>
<p>Besides Kubernetes native kinds (Deployment, StatefulSet, DaemonSet, CronJob),
Flux can be used to patch image references in any Kubernetes custom resource
stored in Git.</p>
<p>The image policy marker format is:</p>
<ul>
<li><code>{&quot;$imagepolicy&quot;: &quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;&quot;}</code></li>
<li><code>{&quot;$imagepolicy&quot;: &quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;:tag&quot;}</code></li>
<li><code>{&quot;$imagepolicy&quot;: &quot;&lt;policy-namespace&gt;:&lt;policy-name&gt;:name&quot;}</code></li>
</ul>
<p><code>HelmRelease</code> example:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>helm.toolkit.fluxcd.io/v2beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>HelmRelease<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">values</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">repository</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:name&#34;}</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">tag</span>:<span style="color:#bbb"> </span><span style="color:#40a070">5.0.0</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:tag&#34;}</span><span style="color:#bbb">
</span></code></pre></div><p>Tekton <code>Task</code> example:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>tekton.dev/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Task<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>golang<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">steps</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>golang<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>docker.io/golang:1.15.6<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:golang&#34;}</span><span style="color:#bbb">
</span></code></pre></div><p>Flux <code>Kustomization</code> example:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>kustomize.toolkit.fluxcd.io/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Kustomization<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">images</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">newName</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:name&#34;}</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">newTag</span>:<span style="color:#bbb"> </span><span style="color:#40a070">5.0.0</span><span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:tag&#34;}</span><span style="color:#bbb">
</span></code></pre></div><p>Kustomize config (<code>kustomization.yaml</code>) example:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>kustomize.config.k8s.io/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Kustomization<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- deployment.yaml<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">images</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">newName</span>:<span style="color:#bbb"> </span>ghcr.io/stefanprodan/podinfo<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:name&#34;}</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">newTag</span>:<span style="color:#bbb"> </span><span style="color:#40a070">5.0.0</span><span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># {&#34;$imagepolicy&#34;: &#34;flux-system:podinfo:tag&#34;}</span><span style="color:#bbb">
</span></code></pre></div><h2 id="push-updates-to-a-different-branch">Push updates to a different branch</h2>
<p>With <code>.spec.git.push.branch</code> you can configure Flux to push the image updates to different branch
than the one used for checkout. If the specified branch doesn&rsquo;t exist, Flux will create it for you.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageUpdateAutomation<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">  
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">git</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">checkout</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">ref</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">branch</span>:<span style="color:#bbb"> </span>main<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">push</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">branch</span>:<span style="color:#bbb"> </span>flux-image-updates<span style="color:#bbb">
</span></code></pre></div><p>You can use CI automation e.g. GitHub Actions such as
Flux&rsquo;s 
<a href="/use-cases/gh-actions-auto-pr">GitHub Actions Auto PR</a> example
to open a pull request against the checkout branch.</p>
<p>This way you can manually approve the image updates before they are applied on your clusters.</p>
<h2 id="configure-the-commit-message">Configure the commit message</h2>
<p>The <code>.spec.git.commit.messageTemplate</code> field is a string which is used as a template for the commit message.</p>
<p>The message template is a 
<a href="https://golang.org/pkg/text/template/" target="_blank">Go text template</a> that
lets you range over the objects and images e.g.:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageUpdateAutomation<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">git</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">commit</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">messageTemplate</span>:<span style="color:#bbb"> </span>|<span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">        Automated image update
</span><span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">        Automation name: {{ .AutomationObject }}
</span><span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">        Files:
</span><span style="color:#4070a0;font-style:italic">        {{ range $filename, $_ := .Updated.Files -}}
</span><span style="color:#4070a0;font-style:italic">        - {{ $filename }}
</span><span style="color:#4070a0;font-style:italic">        {{ end -}}
</span><span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">        Objects:
</span><span style="color:#4070a0;font-style:italic">        {{ range $resource, $_ := .Updated.Objects -}}
</span><span style="color:#4070a0;font-style:italic">        - {{ $resource.Kind }} {{ $resource.Name }}
</span><span style="color:#4070a0;font-style:italic">        {{ end -}}
</span><span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">        Images:
</span><span style="color:#4070a0;font-style:italic">        {{ range .Updated.Images -}}
</span><span style="color:#4070a0;font-style:italic">        - {{.}}
</span><span style="color:#4070a0;font-style:italic">        {{ end -}}</span><span style="color:#bbb">        
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">author</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">email</span>:<span style="color:#bbb"> </span>fluxcdbot@users.noreply.github.com<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>fluxcdbot<span style="color:#bbb">
</span></code></pre></div><h2 id="trigger-image-updates-with-webhooks">Trigger image updates with webhooks</h2>
<p>You may want to trigger a deployment
as soon as a new image tag is pushed to your container registry.
In order to notify the image-reflector-controller about new images,
you can 
<a href="/docs/iac/webhook-receivers/">setup webhook receivers</a>.</p>
<p>First generate a random string and create a secret with a <code>token</code> field:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#bb60d5">TOKEN</span><span style="color:#666">=</span><span style="color:#007020;font-weight:bold">$(</span>head -c <span style="color:#40a070">12</span> /dev/urandom | shasum | cut -d <span style="color:#4070a0">&#39; &#39;</span> -f1<span style="color:#007020;font-weight:bold">)</span>
<span style="color:#007020">echo</span> <span style="color:#bb60d5">$TOKEN</span>

kubectl -n flux-system create secret generic webhook-token <span style="color:#4070a0;font-weight:bold">\	</span>
--from-literal<span style="color:#666">=</span><span style="color:#bb60d5">token</span><span style="color:#666">=</span><span style="color:#bb60d5">$TOKEN</span>
</code></pre></div><p>Define a receiver for DockerHub:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>notification.toolkit.fluxcd.io/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Receiver<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">type</span>:<span style="color:#bbb"> </span>dockerhub<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">secretRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>webhook-token<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageRepository<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span></code></pre></div><p>The notification-controller generates a unique URL using the provided token and the receiver name/namespace.</p>
<p>Find the URL with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl -n flux-system get receiver/podinfo

NAME      READY   STATUS
podinfo   True    Receiver initialised with URL: /hook/bed6d00b5555b1603e1f59b94d7fdbca58089cb5663633fb83f2815dc626d92b
</code></pre></div><p>Log in to DockerHub web interface, go to your image registry Settings and select Webhooks.
Fill the form &ldquo;Webhook URL&rdquo; by composing the address using the receiver
LB and the generated URL <code>http://&lt;LoadBalancerAddress&gt;/&lt;ReceiverURL&gt;</code>.</p>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Other receivers</h4>

    Besides DockerHub, you can define receivers for <strong>Harbor</strong>, <strong>Quay</strong>, <strong>Nexus</strong>, <strong>GCR</strong>,
and any other system that supports webhooks e.g. GitHub Actions, Jenkins, CircleCI, etc.
See the 
<a href="../components/notification/receiver.md">Receiver CRD docs</a> for more details.

</div>

<h2 id="incident-management">Incident management</h2>
<h3 id="suspend-automation">Suspend automation</h3>
<p>During an incident you may wish to stop Flux from pushing image updates to Git.</p>
<p>You can suspend the image automation directly in-cluster:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux <span style="color:#007020">suspend</span> image update flux-system
</code></pre></div><p>Or by editing the <code>ImageUpdateAutomation</code> manifest in Git:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImageUpdateAutomation<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">suspend</span>:<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">true</span><span style="color:#bbb">
</span></code></pre></div><p>Once the incident is resolved, you can resume automation with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux resume image update flux-system
</code></pre></div><p>If you wish to pause the automation for a particular image only,
you can suspend/resume the image scanning:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux <span style="color:#007020">suspend</span> image repository podinfo
</code></pre></div><h3 id="revert-image-updates">Revert image updates</h3>
<p>Assuming you&rsquo;ve configured Flux to update an app to its latest stable version:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image policy podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--image-ref<span style="color:#666">=</span>podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--select-semver<span style="color:#666">=</span><span style="color:#4070a0">&#34;&gt;=5.0.0&#34;</span>
</code></pre></div><p>If the latest version e.g. <code>5.0.1</code> causes an incident in production, you can tell Flux to
revert the image tag to a previous version e.g. <code>5.0.0</code> with:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image policy podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--image-ref<span style="color:#666">=</span>podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--select-semver<span style="color:#666">=</span>5.0.0
</code></pre></div><p>Or by changing the semver range in Git:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ImagePolicy<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>podinfo<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">policy</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">semver</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">range</span>:<span style="color:#bbb"> </span><span style="color:#40a070">5.0.0</span><span style="color:#bbb">
</span></code></pre></div><p>Based on the above configuration, Flux will patch the podinfo deployment manifest in Git
and roll out <code>5.0.0</code> in-cluster.</p>
<p>When a new version is available e.g. <code>5.0.2</code>, you can update the policy once more
and tell Flux to consider only versions greater than <code>5.0.1</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">flux create image policy podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--image-ref<span style="color:#666">=</span>podinfo <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>--select-semver<span style="color:#666">=</span><span style="color:#4070a0">&#34;&gt;5.0.1&#34;</span>
</code></pre></div><h2 id="imagerepository-cloud-providers-authentication">ImageRepository cloud providers authentication</h2>
<p>If relying on a cloud provider image repository, you might need to do some extra
work in order to configure the ImageRepository resource credentials. Here are
some common examples for the most popular cloud provider docker registries.</p>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Workarounds</h4>

    The examples below are intended as workaround solutions until native
authentication mechanisms are implemented in Flux itself to support this in
a more straightforward manner.

</div>

<h3 id="aws-elastic-container-registry">AWS Elastic Container Registry</h3>
<p>The registry authentication credentials for ECR expire every 12 hours.
Considering this limitation, one needs to ensure the credentials are being
refreshed before expiration so that the controller can rely on them for
authentication.</p>
<p>The solution proposed is to create a cronjob that runs every 6 hours which would
re-create the <code>docker-registry</code> secret using a new token.</p>
<p>Edit and save the following snippet to a file
<code>./clusters/my-cluster/ecr-sync.yaml</code>, commit and push it to git.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Role<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">rules</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#062873;font-weight:bold">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#4070a0">&#34;&#34;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- secrets<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">verbs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- get<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- create<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- patch<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>RoleBinding<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">subjects</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">roleRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Role<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">apiGroup</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic"># Uncomment and edit if using IRSA</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic"># annotations:</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic">#   eks.amazonaws.com/role-arn: &lt;role arn&gt;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>CronJob<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">suspend</span>:<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">schedule</span>:<span style="color:#bbb"> </span><span style="color:#40a070">0</span><span style="color:#bbb"> </span><span style="color:#007020">*/6</span><span style="color:#bbb"> </span>*<span style="color:#bbb"> </span>*<span style="color:#bbb"> </span>*<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">failedJobsHistoryLimit</span>:<span style="color:#bbb"> </span><span style="color:#40a070">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">successfulJobsHistoryLimit</span>:<span style="color:#bbb"> </span><span style="color:#40a070">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">jobTemplate</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">serviceAccountName</span>:<span style="color:#bbb"> </span>ecr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>token<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">emptyDir</span>:<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">medium</span>:<span style="color:#bbb"> </span>Memory<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">initContainers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>amazon/aws-cli<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>get-token<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic"># You will need to set the AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables if not using</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic"># IRSA. It is recommended to store the values in a Secret and load them in the container using envFrom.</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic"># envFrom:</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic"># - secretRef:</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#60a0b0;font-style:italic">#     name: aws-credentials</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>REGION<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">value</span>:<span style="color:#bbb"> </span>us-east-1<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># change this if ECR repo is in a different region</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/token<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>token<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- /bin/sh<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- -ce<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- aws ecr get-login-password --region ${REGION} &gt; /token/ecr-token<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>bitnami/kubectl<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>create-secret<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>SECRET_NAME<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">value</span>:<span style="color:#bbb"> </span>ecr-credentials<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ECR_REGISTRY<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">value</span>:<span style="color:#bbb"> </span>&lt;account id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># fill in the account id and region</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">mountPath</span>:<span style="color:#bbb"> </span>/token<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>token<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- /bin/bash<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- -ce<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- |-<span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">              kubectl create secret docker-registry $SECRET_NAME \
</span><span style="color:#4070a0;font-style:italic">                --dry-run=client \
</span><span style="color:#4070a0;font-style:italic">                --docker-server=&#34;$ECR_REGISTRY&#34; \
</span><span style="color:#4070a0;font-style:italic">                --docker-username=AWS \
</span><span style="color:#4070a0;font-style:italic">                --docker-password=&#34;$(&lt;/token/ecr-token)&#34; \
</span><span style="color:#4070a0;font-style:italic">                -o yaml | kubectl apply -f -</span><span style="color:#bbb">              
</span></code></pre></div>

<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Using IAM Roles for Service Accounts (IRSA)</h4>

    If using IRSA, make sure the role attached to the service account has
readonly access to ECR. The AWS managed policy
<code>arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly</code> can be attached
to the role.

</div>

<p>Since the cronjob will not create a job right away, after applying the manifest,
you can manually create an init job using the following command:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl create job --from<span style="color:#666">=</span>cronjob/ecr-credentials-sync -n flux-system ecr-credentials-sync-init
</code></pre></div><p>After the job runs, a secret named <code>ecr-credentials</code> should be created. Use this
name in your ECR ImageRepository resource manifest as the value for
<code>.spec.secretRef.name</code>.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">secretRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>ecr-credentials<span style="color:#bbb">
</span></code></pre></div><h3 id="gcp-container-registry">GCP Container Registry</h3>
<h4 id="using-access-token-short-lived">Using access token [short-lived]</h4>


<div class="alert alert-info" role="alert">
<h4 class="alert-heading">Workload Identity</h4>

    Please ensure that you enable workload identity for your cluster, create a GCP service account that has
access to the container registry and create an IAM policy binding between the GCP service account and
the Kubernetes service account so that the pods created by the cronjob can access GCP APIs and get the token.
Take a look at 
<a href="https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity" target="_blank">this guide</a>

</div>

<p>The access token for GCR expires hourly.
Considering this limitation, one needs to ensure the credentials are being
refreshed before expiration so that the controller can rely on them for
authentication.</p>
<p>The solution proposed is to create a cronjob that runs every 45 minutes which would
re-create the <code>docker-registry</code> secret using a new token.</p>
<p>Edit and save the following snippet to a file
<code>./clusters/my-cluster/gcr-sync.yaml</code>, commit and push it to git.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Role<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">rules</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#062873;font-weight:bold">apiGroups</span>:<span style="color:#bbb"> </span>[<span style="color:#4070a0">&#34;&#34;</span>]<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- secrets<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">verbs</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- get<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- create<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- patch<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>RoleBinding<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>rbac.authorization.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">subjects</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- <span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">roleRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Role<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">apiGroup</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ServiceAccount<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">annotations</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">iam.gke.io/gcp-service-account</span>:<span style="color:#bbb"> </span>&lt;name-of-service-account&gt;@&lt;project-id&gt;.iam.gserviceaccount.com<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>batch/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>CronJob<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">suspend</span>:<span style="color:#bbb"> </span><span style="color:#007020;font-weight:bold">false</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">schedule</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;*/45 * * * *&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">failedJobsHistoryLimit</span>:<span style="color:#bbb"> </span><span style="color:#40a070">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">successfulJobsHistoryLimit</span>:<span style="color:#bbb"> </span><span style="color:#40a070">1</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">jobTemplate</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#062873;font-weight:bold">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">serviceAccountName</span>:<span style="color:#bbb"> </span>gcr-credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">restartPolicy</span>:<span style="color:#bbb"> </span>Never<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#062873;font-weight:bold">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span>- <span style="color:#062873;font-weight:bold">image</span>:<span style="color:#bbb"> </span>google/cloud-sdk<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>create-secret<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">env</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>SECRET_NAME<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">value</span>:<span style="color:#bbb"> </span>gcr-credentials<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- <span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>GCR_REGISTRY<span style="color:#bbb">
</span><span style="color:#bbb">              </span><span style="color:#062873;font-weight:bold">value</span>:<span style="color:#bbb"> </span>&lt;REGISTRY_NAME&gt;<span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># fill in the registry name e.g gcr.io, eu.gcr.io</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#062873;font-weight:bold">command</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- /bin/bash<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- -ce<span style="color:#bbb">
</span><span style="color:#bbb">            </span>- |-<span style="color:#4070a0;font-style:italic">
</span><span style="color:#4070a0;font-style:italic">              kubectl create secret docker-registry $SECRET_NAME \
</span><span style="color:#4070a0;font-style:italic">                --dry-run=client \
</span><span style="color:#4070a0;font-style:italic">                --docker-server=&#34;$GCR_REGISTRY&#34; \
</span><span style="color:#4070a0;font-style:italic">                --docker-username=oauth2accesstoken \
</span><span style="color:#4070a0;font-style:italic">                --docker-password=&#34;$(gcloud auth print-access-token)&#34; \
</span><span style="color:#4070a0;font-style:italic">                -o yaml | kubectl apply -f -</span><span style="color:#bbb">              
</span></code></pre></div><p>Since the cronjob will not create a job right away, after applying the manifest,
you can manually create an init job using the following command:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ kubectl create job --from<span style="color:#666">=</span>cronjob/gcr-credentials-sync -n flux-system gcr-credentials-sync-init
</code></pre></div><p>After the job runs, a secret named <code>gcr-credentials</code> should be created. Use this
name in your GCR ImageRepository resource manifest as the value for
<code>.spec.secretRef.name</code>.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">secretRef</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>gcr-credentials<span style="color:#bbb">
</span></code></pre></div><h4 id="using-a-json-key-long-lived">Using a JSON key [long-lived]</h4>


<div class="alert alert-warning" role="alert">
<h4 class="alert-heading">Less secure option</h4>

    <p>From 
<a href="https://cloud.google.com/container-registry/docs/advanced-authentication#json-key" target="_blank">Google documentation on authenticating container registry</a></p>
<blockquote>
<p>A user-managed key-pair that you can use as a credential for a service account.
Because the credential is long-lived, it is the least secure option of all the available authentication methods.
When possible, use an access token or another available authentication method to reduce the risk of
unauthorized access to your artifacts. If you must use a service account key,
ensure that you follow best practices for managing credentials.</p>
</blockquote>


</div>

<p>A Json key doesn&rsquo;t expire, so we don&rsquo;t need a cronjob,
we just need to create the secret and reference it in the ImagePolicy.</p>
<p>First, create a json key file by following this

<a href="https://cloud.google.com/container-registry/docs/advanced-authentication" target="_blank">documentation</a>.
Grant the service account the role of <code>Container Registry Service Agent</code>
so that it can access GCR and download the json file.</p>
<p>Then create a secret, encrypt it using 
<a href="/docs/iac/mozilla-sops/">Mozilla SOPS</a>
or 
<a href="/docs/iac/sealed-secrets/">Sealed Secrets</a> , commit and push the encypted file to git.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">kubectl create secret docker-registry &lt;secret-name&gt; <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --docker-server<span style="color:#666">=</span>&lt;GCR-REGISTRY&gt; <span style="color:#4070a0;font-weight:bold">\ </span><span style="color:#60a0b0;font-style:italic"># e.g gcr.io</span>
  --docker-username<span style="color:#666">=</span>_json_key <span style="color:#4070a0;font-weight:bold">\
</span><span style="color:#4070a0;font-weight:bold"></span>  --docker-password<span style="color:#666">=</span><span style="color:#4070a0">&#34;</span><span style="color:#007020;font-weight:bold">$(</span>cat &lt;downloaded-json-file&gt;<span style="color:#007020;font-weight:bold">)</span><span style="color:#4070a0">&#34;</span>
</code></pre></div><h3 id="azure-container-registry">Azure Container Registry</h3>
<p>AKS clusters are not able to pull and run images from ACR by default.
Read 
<a href="https://docs.microsoft.com/en-us/azure/aks/cluster-container-registry-integration" target="_blank">Integrating AKS /w ACR</a> as a potential pre-requisite
before integrating Flux <code>ImageRepositories</code> with ACR.</p>
<p>Note that the resulting ImagePullSecret for Flux could also be specified by Pods within the same Namespace to pull and run ACR images as well.</p>
<h4 id="generating-tokens-for-managed-identities-short-lived">Generating Tokens for Managed Identities [short-lived]</h4>
<p>As a pre-requisite, your AKS cluster will need 
<a href="../use-cases/azure.md#aad-pod-identity">AAD Pod Identity</a> installed.</p>
<p>Once we have AAD Pod Identity installed, we can create a Deployment that frequently refreshes an image pull secret into
our desired Namespace.</p>
<p>Create a directory in your control repository and save this <code>kustomization.yaml</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#60a0b0;font-style:italic"># kustomization.yaml</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>kustomize.config.k8s.io/v1beta1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>Kustomization<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- https://github.com/fluxcd/flux2/manifests/integrations/registry-credentials-sync/azure?ref=main<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">patchesStrategicMerge</span>:<span style="color:#bbb">
</span><span style="color:#bbb"></span>- config-patches.yaml<span style="color:#bbb">
</span></code></pre></div><p>Save and configure the following patch &ndash; note the instructional comments for configuring matching Azure resources:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#60a0b0;font-style:italic"># config-patches.yaml</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>ConfigMap<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>credentials-sync<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">data</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">ACR_NAME</span>:<span style="color:#bbb"> </span>my-registry<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">KUBE_SECRET</span>:<span style="color:#bbb"> </span>my-registry <span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># does not yet exist -- will be created in the same Namespace</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">SYNC_PERIOD</span>:<span style="color:#bbb"> </span><span style="color:#4070a0">&#34;3600&#34;</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic"># ACR tokens expire every 3 hours; refresh faster than that</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic"># Create an identity in Azure and assign it a role to pull from ACR  (note: the identity&#39;s resourceGroup should match the desired ACR):</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">#     az identity create -n acr-sync</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">#     az role assignment create --role AcrPull --assignee-object-id &#34;$(az identity show -n acr-sync -o tsv --query principalId)&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic"># Fetch the clientID and resourceID to configure the AzureIdentity spec below:</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">#     az identity show -n acr-sync -otsv --query clientId</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#60a0b0;font-style:italic">#     az identity show -n acr-sync -otsv --query resourceId</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#0e84b5;font-weight:bold">---</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">apiVersion</span>:<span style="color:#bbb"> </span>aadpodidentity.k8s.io/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">kind</span>:<span style="color:#bbb"> </span>AzureIdentity<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">name</span>:<span style="color:#bbb"> </span>credentials-sync <span style="color:#bbb"> </span><span style="color:#60a0b0;font-style:italic"># name must match the stub-resource in az-identity.yaml</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">namespace</span>:<span style="color:#bbb"> </span>flux-system<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#062873;font-weight:bold">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">clientID</span>:<span style="color:#bbb"> </span>4ceaa448-d7b9-4a80-8f32-497eaf3d3287<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">resourceID</span>:<span style="color:#bbb"> </span>/subscriptions/8c69185e-55f9-4d00-8e71-a1b1bb1386a1/resourcegroups/stealthybox/providers/Microsoft.ManagedIdentity/userAssignedIdentities/acr-sync<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#062873;font-weight:bold">type</span>:<span style="color:#bbb"> </span><span style="color:#40a070">0</span><span style="color:#bbb">  </span><span style="color:#60a0b0;font-style:italic"># user-managed identity</span><span style="color:#bbb">
</span></code></pre></div><p>Verify that <code>kustomize build .</code> works, then commit the directory to you control repo.
Flux will apply the Deployment and it will use the AAD managed identity for that Pod to regularly fetch ACR tokens into your configured <code>KUBE_SECRET</code> name.
Reference the <code>KUBE_SECRET</code> value from any <code>ImageRepository</code> objects for that ACR registry.</p>
<p>This example uses the <code>fluxcd/flux2</code> github archive as a remote base, but you may copy the 
<a href="https://github.com/fluxcd/flux2/tree/main/manifests/integrations/registry-credentials-sync/azure" target="_blank">./manifests/integrations/registry-credentials-sync/azure</a>
folder into your own repository or use a git submodule to vendor it if preferred.</p>
<h4 id="using-static-credentials-long-lived">Using Static Credentials [long-lived]</h4>


<div class="alert alert-info" role="alert">


    Using a static credential requires a Secrets management solution compatible with your GitOps workflow.

</div>

<p>Follow the official Azure documentation for 
<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-auth-kubernetes" target="_blank">Creating an Image Pull Secret for ACR</a>.</p>
<p>Instead of creating the Secret directly into your Kubernetes cluster, encrypt it using 
<a href="/docs/iac/mozilla-sops/">Mozilla SOPS</a>
or 
<a href="/docs/iac/sealed-secrets/">Sealed Secrets</a>, then commit and push the encypted file to git.</p>
<p>This Secret should be in the same Namespace as your flux <code>ImageRepository</code> object.
Update the <code>ImageRepository.spec.secretRef</code> to point to it.</p>
<p>It is also possible to create 
<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-repository-scoped-permissions" target="_blank">Repository Scoped Tokens</a>.</p>


<div class="alert alert-info" role="alert">


    Note that this feature is in preview and does have limitations.

</div>


	
	
	<div class="text-muted mt-5 pt-3 border-top">

</div>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/fluxcd" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="LinkedIn" aria-label="LinkedIn">
    <a class="text-white" target="_blank" rel="noopener" href="https://linkedin.com/groups/8985374" aria-label="LinkedIn">
      <i class="fab fa-linkedin"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="RSS Feed" aria-label="RSS Feed">
    <a class="text-white" target="_blank" rel="noopener" href="/blog/index.xml" aria-label="RSS Feed">
      <i class="fa fa-rss"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Support" aria-label="Support">
    <a class="text-white" target="_blank" rel="noopener" href="/support" aria-label="Support">
      <i class="fas fa-comments"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Flux project on GitHub" aria-label="Flux project on GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/fluxcd" aria-label="Flux project on GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://cloud-native.slack.com/messages/flux" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://lists.cncf.io/g/cncf-flux-dev" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Flux YouTube channel" aria-label="Flux YouTube channel">
    <a class="text-white" target="_blank" rel="noopener" href="https://www.youtube.com/channel/UCoZxt-YMhGHb20ZkvcCc5KA" aria-label="Flux YouTube channel">
      <i class="fab fa-youtube"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Flux authors </small>
        
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>






 











<script src="/js/main.min.5c74b870c6953931a705f390a49c7e4c0a842ec5c83b24354758dd674343ed0d.js" integrity="sha256-XHS4cMaVOTGnBfOQpJx&#43;TAqELsXIOyQ1R1jdZ0ND7Q0=" crossorigin="anonymous"></script>



<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript"> docsearch({
apiKey: '45f9f14d53600b0a2cafa46a26ee10f4',
indexName: 'fluxcd',
inputSelector: '.td-search-input',

algoliaOptions: { 'facetFilters': ["tags:current"] },

debug: false 
});
</script>



  </body>
</html>